pipeline {
    agent any

    stages {

        stage('Verify Shell Environment') {
            steps {
                script {
                    echo "Job Name: ${env.JOB_NAME}"
                    echo "Build Number: ${env.BUILD_NUMBER}"
                }
                sh '''
                    docker --version
                    dotnet --info
                '''
            }
        }

        stage('Checkout Jenkins Upgrade3 Git Repository') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/master']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/Shayamkumarsingh/Jenkins_Upgradev3.git'
                    ]],
                    extensions: [
                        [$class: 'CleanBeforeCheckout'],
                        [$class: 'CloneOption', shallow: true, depth: 1]
                    ]
                ])
            }
        }

        stage('Build Application') {
            steps {
                sh '''
                    chmod +x ./jenkins-plugin-model/ci/01-build.sh
                    ./jenkins-plugin-model/ci/01-build.sh
                '''
            }
        }

        stage('Unit Test') {
            steps {
                sh '''
                    chmod +x ./jenkins-plugin-model/ci/03-unit-test.sh
                    ./jenkins-plugin-model/ci/03-unit-test.sh
                '''
                mstest testResultsFile: "**/*.trx"
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    echo "Job Name: ${env.JOB_NAME}"
                    echo "Build Number: ${env.BUILD_NUMBER}"
                }

                withCredentials([
                    usernamePassword(
                        credentialsId: '0e58a647-c9a7-4400-8d6d-fa2faf6e9059',
                        usernameVariable: 'DOCKER_HUB_USER',
                        passwordVariable: 'DOCKER_HUB_PASSWORD'
                    )
                ]) {
                    sh '''
                        chmod +x ./jenkins-plugin-model/ci/04-push.sh
                        ./jenkins-plugin-model/ci/04-push.sh ${BUILD_NUMBER}
                    '''
                }

                echo "Build Completed - Job Name: ${env.JOB_NAME} -- Build Number: ${env.BUILD_NUMBER}"
            }
        }
    }
}
